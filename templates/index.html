<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Dog Breed Classifier</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    #output img { max-width: 320px; margin-top: 16px; border-radius: 8px; }
    .prediction { margin: 6px 0; font-size: 18px; }
    .error { color: #b00020; margin-top: 12px; }
    .loading { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <h1>üê∂ Dog Breed Classifier</h1>

  <form id="uploadForm">
    <input type="file" id="imageFile" name="file" accept="image/*" required />
    <br><br>
    <button id="btn" type="submit">Pr√©dire</button>
  </form>

  <div id="output">
    <img id="preview" src="#" alt="" style="display:none;" />
    <div id="predictions"></div>
    <div id="error" class="error"></div>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    const btn = document.getElementById('btn');
    const preview = document.getElementById('preview');
    const predictionsDiv = document.getElementById('predictions');
    const errorDiv = document.getElementById('error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      predictionsDiv.innerHTML = '';

      const fileInput = document.getElementById('imageFile');
      const file = fileInput.files[0];
      if (!file) {
        errorDiv.textContent = "Aucune image s√©lectionn√©e.";
        return;
      }

      // Aper√ßu
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);

      // D√©sactiver UI pendant la requ√™te
      document.body.classList.add('loading');
      btn.textContent = 'Pr√©diction en cours...';

      try {
        const formData = new FormData();
        formData.append('file', file);

        // Si front et back sont au m√™me domaine: '/predict'
        // Sinon, mets l‚ÄôURL compl√®te: 'http://127.0.0.1:5000/predict'
        const resp = await fetch('/predict', { method: 'POST', body: formData });

        if (!resp.ok) {
          // Essayer de lire le message d‚Äôerreur JSON si dispo
          let msg = `Erreur serveur (${resp.status})`;
          try { const ejson = await resp.json(); if (ejson.error) msg = ejson.error; } catch {}
          throw new Error(msg);
        }

        const data = await resp.json();

        // ‚ö†Ô∏è ICI la r√©ponse de l‚ÄôAPI est { predictions: [...] }
        const predictions = Array.isArray(data) ? data : (data.predictions || []);

        if (!predictions.length) {
          errorDiv.textContent = "Pas de pr√©dictions retourn√©es.";
          return;
        }

        predictionsDiv.innerHTML = '';
        predictions.forEach(pred => {
          const p = document.createElement('div');
          p.className = 'prediction';
          p.textContent = `${pred.label} ‚Üí ${(pred.score * 100).toFixed(2)}%`;
          predictionsDiv.appendChild(p);
        });
      } catch (err) {
        errorDiv.textContent = err.message || 'Erreur inconnue.';
      } finally {
        document.body.classList.remove('loading');
        btn.textContent = 'Pr√©dire';
      }
    });
  </script>
</body>
</html>
